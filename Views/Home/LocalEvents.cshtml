@model IEnumerable<PROG7312_POE.Models.LocalEvent>

@{
    ViewData["Title"] = "Local Events";
}

<!-- Page Header -->
<div class="report-header">
    <div class="container">
        <a href="@Url.Action("Index", "Home")" class="back-link">← Back to Home</a>
        <h1 class="page-title">Local Events & Announcements</h1>
        <p class="page-subtitle">Stay informed about community events, municipal announcements, and activities in Cape Town.</p>
    </div>
</div>

<!-- Page Content -->
<div class="report-content">
    <div class="container">
        
        <!-- Search and Filter Section -->
        <div class="form-card">
            <h3>Find Events</h3>
            <p class="subtitle">Search for events by category, date, or location.</p>
            
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">🔍 Search Events</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search events...">
                </div>
                <div class="col-md-4">
                    <label class="form-label">📂 Category</label>
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="Community">Community</option>
                        <option value="Sports">Sports & Recreation</option>
                        <option value="Arts">Arts & Culture</option>
                        <option value="Education">Education</option>
                        <option value="Health">Health & Wellness</option>
                        <option value="Environment">Environment</option>
                        <option value="Municipal">Municipal Meetings</option>
                        <option value="Safety">Public Safety</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">📅 Date Range</label>
                    <select class="form-select" id="dateFilter">
                        <option value="">All Dates</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="upcoming">Upcoming</option>
                    </select>
                </div>
            </div>
            
            <!-- Viewing History Buttons -->
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                <button class="btn btn-outline-secondary" id="viewHistoryBtn" style="display: none;">
                    📚 View History (<span id="historyCount">0</span>)
                </button>
                <button class="btn btn-outline-primary" id="previousEventBtn" style="display: none;">
                    ⬅️ Previous Event
                </button>
                <button class="btn btn-outline-danger" id="clearHistoryBtn" style="display: none;">
                    🗑️ Clear History
                </button>
            </div>
        </div>

        <!-- Featured Events Section -->
        <div class="info-card">
            <h3>Featured Events</h3>
            
            @if (Model != null && Model.Any())
            {
                <p class="subtitle">📊 Displaying @Model.Count() events from Dictionary-based repository | <span id="visibleEventsCount">@Math.Min(Model.Count(), 17)</span> visible</p>
            }
            
            <!-- Scrollable Events Container -->
            <div class="events-scroll-container">
                <div class="row g-4" id="featuredEvents">
                    
                    @if (Model != null && Model.Any())
                    {
                        foreach (var evt in Model)
                        {
                            var categoryClass = evt.Category.ToLower() switch
                            {
                                "community" => "event-badge-community",
                                "arts" => "event-badge-arts",
                                "municipal" => "event-badge-municipal",
                                "sports" => "event-badge-sports",
                                "health" => "event-badge-health",
                                "environment" => "event-badge-environment",
                                "education" => "event-badge-education",
                                "safety" => "event-badge-safety",
                                _ => "event-badge-community"
                            };
                            
                            <div class="col-md-6 col-lg-4">
                                <div class="event-card" 
                                     data-category="@evt.Category" 
                                     data-date="@evt.EventDate.ToString("yyyy-MM-dd")" 
                                     data-event-id="@evt.Id"
                                     data-event-title="@evt.Title"
                                     data-event-description="@evt.Description"
                                     data-event-time="@evt.EventDate.ToString("h:mm tt")"
                                     data-event-location="@evt.Location"
                                     data-event-status="@evt.Status"
                                     data-event-created="@evt.CreatedAt.ToString("MMM dd, yyyy")">
                                    <div class="event-badge @categoryClass">@evt.Category</div>
                                    <div class="event-date">
                                        <div class="event-day">@evt.EventDate.Day</div>
                                        <div class="event-month">@evt.EventDate.ToString("MMM").ToUpper()</div>
                                    </div>
                                    <h4 class="event-title">@evt.Title</h4>
                                    <div class="event-details">
                                        <div class="event-detail-item">
                                            <span class="event-icon">🕐</span>
                                            <span>@evt.EventDate.ToString("h:mm tt")</span>
                                        </div>
                                        <div class="event-detail-item">
                                            <span class="event-icon">📍</span>
                                            <span>@evt.Location</span>
                                        </div>
                                    </div>
                                    <p class="event-description">@evt.Description</p>
                                    <button class="btn-event-details" data-event-id="@evt.Id">View Details</button>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-12">
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <div style="font-size: 3rem; margin-bottom: 20px;">📅</div>
                                <h4>No Events Available</h4>
                                <p>Dictionary is empty. Events will be seeded on next page load.</p>
                            </div>
                        </div>
                    }

                </div>
            </div>

            <!-- No Results Message -->
            <div id="noResults" style="display: none; text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 3rem; margin-bottom: 20px;">📅</div>
                <h4>No Events Found</h4>
                <p>Try adjusting your search criteria or filters.</p>
            </div>
            
            <!-- Scroll Indicator -->
            <div class="scroll-indicator" id="scrollIndicator">
                <span>⬇️ Scroll down to see more events ⬇️</span>
            </div>
        </div>

        <!-- Information Cards Row -->
        <div class="info-cards-row">
            <!-- Event Categories Card -->
            <div class="process-card">
                <h3>Event Categories</h3>
                
                <div class="category-list">
                    <div class="category-item">
                        <span class="category-icon">👥</span>
                        <div>
                            <strong>Community Events</strong>
                            <p>Neighborhood meetings, clean-ups, and social gatherings</p>
                        </div>
                    </div>
                    <div class="category-item">
                        <span class="category-icon">🎨</span>
                        <div>
                            <strong>Arts & Culture</strong>
                            <p>Markets, exhibitions, performances, and festivals</p>
                        </div>
                    </div>
                    <div class="category-item">
                        <span class="category-icon">🏃</span>
                        <div>
                            <strong>Sports & Recreation</strong>
                            <p>Marathons, tournaments, and fitness activities</p>
                        </div>
                    </div>
                    <div class="category-item">
                        <span class="category-icon">🏛️</span>
                        <div>
                            <strong>Municipal Meetings</strong>
                            <p>Public consultations and council meetings</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscribe Card -->
            <div class="process-card">
                <h3>Stay Updated</h3>
                
                <p>Subscribe to receive notifications about upcoming events in your area.</p>
                
                <div class="subscribe-form">
                    <label class="form-label">📧 Email Address</label>
                    <input type="email" class="form-control" placeholder="your.email@example.com">
                    
                    <label class="form-label" style="margin-top: 15px;">📍 Preferred Areas</label>
                    <select class="form-select" multiple size="4">
                        <option>City Centre</option>
                        <option>Northern Suburbs</option>
                        <option>Southern Suburbs</option>
                        <option>Atlantic Seaboard</option>
                        <option>Cape Flats</option>
                    </select>
                    
                    <button class="btn-submit" style="margin-top: 20px; width: 100%;">Subscribe to Updates</button>
                </div>

                <p class="response-note" style="margin-top: 15px;">
                    You can unsubscribe at any time. We respect your privacy.
                </p>
            </div>
        </div>

    </div>
</div>

<!-- Event Details Modal -->
<div class="event-modal-overlay" id="eventModalOverlay" style="display: none;">
    <div class="event-modal">
        <div class="event-modal-header">
            <h2 id="modalEventTitle">Event Title</h2>
            <button class="event-modal-close" id="closeModalBtn">&times;</button>
        </div>
        <div class="event-modal-body">
            <div class="modal-event-badge" id="modalEventBadge">Category</div>
            
            <div class="modal-section">
                <h4>📅 Date & Time</h4>
                <p id="modalEventDateTime">Date and time</p>
            </div>
            
            <div class="modal-section">
                <h4>📍 Location</h4>
                <p id="modalEventLocation">Location details</p>
            </div>
            
            <div class="modal-section">
                <h4>📝 Description</h4>
                <p id="modalEventDescription">Event description</p>
            </div>
            
            <div class="modal-section">
                <h4>ℹ️ Event Information</h4>
                <div class="modal-info-grid">
                    <div>
                        <strong>Status:</strong>
                        <span id="modalEventStatus">Status</span>
                    </div>
                    <div>
                        <strong>Created:</strong>
                        <span id="modalEventCreated">Created date</span>
                    </div>
                    <div>
                        <strong>Event ID:</strong>
                        <span id="modalEventId">ID</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="event-modal-footer">
            <button class="btn-modal-close" id="closeModalBtn2">Close</button>
        </div>
    </div>
</div>

<!-- History Modal -->
<div class="event-modal-overlay" id="historyModalOverlay" style="display: none;">
    <div class="event-modal">
        <div class="event-modal-header">
            <h2>📚 Viewing History</h2>
            <button class="event-modal-close" id="closeHistoryModalBtn">&times;</button>
        </div>
        <div class="event-modal-body">
            <p style="color: #666; margin-bottom: 20px;">Click on any event to view its details. Most recent views appear at the top.</p>
            <div id="historyList" style="max-height: 400px; overflow-y: auto;">
                <!-- History items will be populated here -->
            </div>
        </div>
        <div class="event-modal-footer">
            <button class="btn-modal-close" id="closeHistoryModalBtn2">Close</button>
        </div>
    </div>
</div>

<!-- Dictionary Debug Info (remove in production) -->
@if (Model != null)
{
    <div class="alert alert-success" role="alert">
        <strong>✅ Dictionary Active!</strong><br/>
        <small>
            - Total events in model: @Model.Count()<br/>
            - Events are stored in: Dictionary&lt;string, LocalEvent&gt;, SortedDictionary&lt;DateTime, List&lt;LocalEvent&gt;&gt;<br/>
            - Categories: @string.Join(", ", Model.Select(e => e.Category).Distinct())
        </small>
    </div>
}
else
{
    <div class="alert alert-danger" role="alert">
        <strong>❌ Dictionary NOT working!</strong> Model is null.
    </div>
}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const dateFilter = document.getElementById('dateFilter');
        const eventCards = document.querySelectorAll('.event-card');
        const noResults = document.getElementById('noResults');
        const scrollContainer = document.querySelector('.events-scroll-container');
        const scrollIndicator = document.getElementById('scrollIndicator');
        const visibleEventsCount = document.getElementById('visibleEventsCount');
        
        // Modal elements
        const modalOverlay = document.getElementById('eventModalOverlay');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeModalBtn2 = document.getElementById('closeModalBtn2');
        
        // History modal elements
        const historyModalOverlay = document.getElementById('historyModalOverlay');
        const closeHistoryModalBtn = document.getElementById('closeHistoryModalBtn');
        const closeHistoryModalBtn2 = document.getElementById('closeHistoryModalBtn2');
        const viewHistoryBtn = document.getElementById('viewHistoryBtn');
        const previousEventBtn = document.getElementById('previousEventBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const historyList = document.getElementById('historyList');
        const historyCount = document.getElementById('historyCount');
        
        // Stack for viewing history (LIFO - Last In, First Out)
        class EventStack {
            constructor() {
                this.items = [];
                this.maxSize = 20; // Limit stack size to prevent memory issues
            }
            
            // Push event to stack
            push(eventData) {
                // Remove duplicate if exists (to avoid same event multiple times in a row)
                const existingIndex = this.items.findIndex(item => item.id === eventData.id);
                if (existingIndex === 0) {
                    // If it's already at the top, don't add again
                    return;
                }
                if (existingIndex > 0) {
                    // Remove from middle/bottom
                    this.items.splice(existingIndex, 1);
                }
                
                // Add to top of stack
                this.items.unshift(eventData);
                
                // Maintain max size
                if (this.items.length > this.maxSize) {
                    this.items.pop();
                }
                
                this.saveToLocalStorage();
            }
            
            // Pop event from stack (remove and return top item)
            pop() {
                if (this.items.length > 0) {
                    const item = this.items.shift();
                    this.saveToLocalStorage();
                    return item;
                }
                return null;
            }
            
            // Peek at top item without removing
            peek() {
                return this.items.length > 0 ? this.items[0] : null;
            }
            
            // Get all items (for display purposes)
            getAll() {
                return [...this.items];
            }
            
            // Check if stack is empty
            isEmpty() {
                return this.items.length === 0;
            }
            
            // Get stack size
            size() {
                return this.items.length;
            }
            
            // Clear stack
            clear() {
                this.items = [];
                this.saveToLocalStorage();
            }
            
            // Save to localStorage
            saveToLocalStorage() {
                localStorage.setItem('eventViewHistory', JSON.stringify(this.items));
            }
            
            // Load from localStorage
            loadFromLocalStorage() {
                const stored = localStorage.getItem('eventViewHistory');
                if (stored) {
                    try {
                        this.items = JSON.parse(stored);
                    } catch (e) {
                        console.error('Error loading history:', e);
                        this.items = [];
                    }
                }
            }
        }
        
        // Initialize stack
        const viewHistory = new EventStack();
        viewHistory.loadFromLocalStorage();
        
        // Update UI based on stack state
        function updateHistoryUI() {
            const stackSize = viewHistory.size();
            historyCount.textContent = stackSize;
            
            if (stackSize > 0) {
                viewHistoryBtn.style.display = 'inline-block';
                previousEventBtn.style.display = 'inline-block';
                clearHistoryBtn.style.display = 'inline-block';
            } else {
                viewHistoryBtn.style.display = 'none';
                previousEventBtn.style.display = 'none';
                clearHistoryBtn.style.display = 'none';
            }
        }

        // Function to update visible events count
        function updateVisibleCount() {
            const visibleCards = Array.from(eventCards).filter(card => 
                card.parentElement.style.display !== 'none'
            );
            if (visibleEventsCount) {
                visibleEventsCount.textContent = visibleCards.length;
            }
        }

        // Hide scroll indicator when scrolled to bottom
        if (scrollContainer && scrollIndicator) {
            scrollContainer.addEventListener('scroll', function() {
                const isAtBottom = scrollContainer.scrollHeight - scrollContainer.scrollTop <= scrollContainer.clientHeight + 50;
                if (isAtBottom) {
                    scrollIndicator.classList.add('hidden');
                } else {
                    scrollIndicator.classList.remove('hidden');
                }
            });

            // Check if scrollable on load
            if (scrollContainer.scrollHeight <= scrollContainer.clientHeight) {
                scrollIndicator.classList.add('hidden');
            }
        }

        function filterEvents() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            const selectedDate = dateFilter.value;
            let visibleCount = 0;

            eventCards.forEach(card => {
                const title = card.querySelector('.event-title').textContent.toLowerCase();
                const description = card.querySelector('.event-description').textContent.toLowerCase();
                const category = card.dataset.category;
                const eventDate = new Date(card.dataset.date);
                const today = new Date();

                // Search filter
                const matchesSearch = searchTerm === '' || 
                    title.includes(searchTerm) || 
                    description.includes(searchTerm);

                // Category filter
                const matchesCategory = selectedCategory === '' || category === selectedCategory;

                // Date filter
                let matchesDate = true;
                if (selectedDate === 'today') {
                    matchesDate = eventDate.toDateString() === today.toDateString();
                } else if (selectedDate === 'week') {
                    const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                    matchesDate = eventDate >= today && eventDate <= weekFromNow;
                } else if (selectedDate === 'month') {
                    const monthFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
                    matchesDate = eventDate >= today && eventDate <= monthFromNow;
                } else if (selectedDate === 'upcoming') {
                    matchesDate = eventDate >= today;
                }

                // Show or hide card
                if (matchesSearch && matchesCategory && matchesDate) {
                    card.parentElement.style.display = 'block';
                    visibleCount++;
                } else {
                    card.parentElement.style.display = 'none';
                }
            });

            // Show "no results" message if no cards are visible
            const hasVisibleCards = visibleCount > 0;
            noResults.style.display = hasVisibleCards ? 'none' : 'block';
            
            // Update visible count
            updateVisibleCount();

            // Check if scroll indicator should be shown
            if (scrollContainer && scrollIndicator) {
                if (hasVisibleCards && scrollContainer.scrollHeight > scrollContainer.clientHeight) {
                    scrollIndicator.classList.remove('hidden');
                } else {
                    scrollIndicator.classList.add('hidden');
                }
            }

            // Reset scroll position when filtering
            if (scrollContainer) {
                scrollContainer.scrollTop = 0;
            }
        }

        // Function to open modal with event details
        function openEventModal(eventData, addToHistory = true) {
            // Add to history stack
            if (addToHistory) {
                viewHistory.push(eventData);
                updateHistoryUI();
            }
            
            // Populate modal
            document.getElementById('modalEventTitle').textContent = eventData.title;
            document.getElementById('modalEventBadge').textContent = eventData.category;
            document.getElementById('modalEventDateTime').textContent = `${new Date(eventData.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} at ${eventData.time}`;
            document.getElementById('modalEventLocation').textContent = eventData.location;
            document.getElementById('modalEventDescription').textContent = eventData.description;
            document.getElementById('modalEventStatus').textContent = eventData.status;
            document.getElementById('modalEventCreated').textContent = eventData.created;
            document.getElementById('modalEventId').textContent = eventData.id;
            
            // Show modal
            modalOverlay.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        // Function to close modal
        function closeEventModal() {
            modalOverlay.style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }
        
        // Function to show history modal
        function showHistoryModal() {
            const history = viewHistory.getAll();
            
            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No viewing history yet.</p>';
            } else {
                historyList.innerHTML = history.map((event, index) => `
                    <div class="history-item" data-event-index="${index}" style="
                        padding: 15px;
                        border: 2px solid #e0e0e0;
                        border-radius: 8px;
                        margin-bottom: 10px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        background: white;
                    " onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateX(5px)';" 
                       onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateX(0)';">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1a1a1a; margin-bottom: 5px;">${event.title}</div>
                                <div style="font-size: 0.9rem; color: #666;">
                                    <span style="margin-right: 15px;">📍 ${event.location}</span>
                                    <span>📅 ${new Date(event.date).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 4px 10px;
                                border-radius: 12px;
                                font-size: 0.75rem;
                                font-weight: 600;
                                white-space: nowrap;
                            ">${event.category}</div>
                        </div>
                    </div>
                `).join('');
                
                // Add click handlers to history items
                document.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const index = parseInt(this.dataset.eventIndex);
                        const eventData = history[index];
                        closeHistoryModal();
                        openEventModal(eventData, false); // Don't add to history again
                    });
                });
            }
            
            historyModalOverlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        // Function to close history modal
        function closeHistoryModal() {
            historyModalOverlay.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Add event listeners
        searchInput.addEventListener('input', filterEvents);
        categoryFilter.addEventListener('change', filterEvents);
        dateFilter.addEventListener('change', filterEvents);

        // Event details button handlers
        document.querySelectorAll('.btn-event-details').forEach(button => {
            button.addEventListener('click', function() {
                const eventCard = this.closest('.event-card');
                const eventData = {
                    title: eventCard.dataset.eventTitle,
                    description: eventCard.dataset.eventDescription,
                    category: eventCard.dataset.category,
                    date: eventCard.dataset.date,
                    time: eventCard.dataset.eventTime,
                    location: eventCard.dataset.eventLocation,
                    status: eventCard.dataset.eventStatus,
                    created: eventCard.dataset.eventCreated,
                    id: eventCard.dataset.eventId
                };
                openEventModal(eventData);
            });
        });

        // Modal close handlers
        closeModalBtn.addEventListener('click', closeEventModal);
        closeModalBtn2.addEventListener('click', closeEventModal);
        
        // Close modal when clicking outside
        modalOverlay.addEventListener('click', function(e) {
            if (e.target === modalOverlay) {
                closeEventModal();
            }
        });

        // History modal handlers
        viewHistoryBtn.addEventListener('click', showHistoryModal);
        closeHistoryModalBtn.addEventListener('click', closeHistoryModal);
        closeHistoryModalBtn2.addEventListener('click', closeHistoryModal);
        
        historyModalOverlay.addEventListener('click', function(e) {
            if (e.target === historyModalOverlay) {
                closeHistoryModal();
            }
        });

        // Previous event button (pop from stack)
        previousEventBtn.addEventListener('click', function() {
            if (!viewHistory.isEmpty()) {
                // Pop removes the most recent (current) event
                viewHistory.pop();
                
                // Peek at the new top (previous event)
                const previousEvent = viewHistory.peek();
                
                if (previousEvent) {
                    openEventModal(previousEvent, false); // Don't add back to history
                }
                
                updateHistoryUI();
            }
        });
        
        // Clear history button
        clearHistoryBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear your viewing history?')) {
                viewHistory.clear();
                updateHistoryUI();
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (modalOverlay.style.display === 'flex') {
                    closeEventModal();
                }
                if (historyModalOverlay.style.display === 'flex') {
                    closeHistoryModal();
                }
            }
        });

        // Initial UI update
        updateVisibleCount();
        updateHistoryUI();
    });
</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}